<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<title>å˜æ›´æ£€æŸ¥è¡¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰v20241211e - ä»£ç å·®å¼‚å±•ç¤º</title>

<style>
body{font-family:"SF Pro Display","Microsoft YaHei";background:#F2F2F7;margin:0;padding:22px;color:#111;}
h2{font-size:22px;margin-bottom:16px;font-weight:600;}
.container{background:#ffffff;border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.05);}

/* æ“ä½œæ æ ·å¼ */
.controls{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;}

/* æŸ¥è¯¢åŒºåŸŸæ ·å¼ */
.query-section{display:flex;gap:8px;align-items:center;}

/* æœç´¢åŒºåŸŸæ ·å¼ */
.search-section{display:flex;gap:8px;flex:1;max-width:500px;}

/* æ“ä½œæŒ‰é’®åŒºåŸŸæ ·å¼ */
.action-section{display:flex;gap:8px;align-items:center;flex-shrink:0;}

/* è¾“å…¥æ¡†ç‰¹æ®Šæ ·å¼ */
.user-input{width:120px;}
.month-input{width:150px;}
.project-input{width:300px;}
.search-input{flex:1;padding:8px 12px;border:1px solid #C6C6C8;border-radius:8px;background:#fafafa;font-size:14px;}
.filter-select{padding:8px 12px;border:1px solid #C6C6C8;border-radius:8px;background:#fafafa;font-size:14px;cursor:pointer;}

input,textarea{
 width:100%;padding:6px;border:1px solid #C6C6C8;border-radius:8px;
 background:#fafafa;font-size:13px;transition:.15s;resize:none;
}
input:focus,textarea:focus{
 background:white;border-color:#007AFF;outline:none;
 box-shadow:0 0 0 2px rgba(0,122,255,.3);
}
textarea{min-height:40px;}
input.error,textarea.error{border-color:#FF3B30;}

button{border:none;padding:6px 12px;border-radius:10px;cursor:pointer;font-weight:500;font-size:13px;transition:0.2s;}
button:hover{opacity:0.85;transform:translateY(-1px);}
button:active{transform:translateY(0);}
.btn-blue{background:#007AFF;color:white;}
.btn-green{background:#34C759;color:white;}
.btn-red{background:#FF3B30;color:white;}
.btn-gray{background:#E5E5EA;color:black;}
.btn-orange{background:#FF9500;color:white;}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.save-indicator{display:inline-block;margin-left:10px;font-size:12px;color:#8E8E93;}
.save-indicator.saving{color:#FF9500;}
.save-indicator.success{color:#34C759;}
.save-indicator.error{color:#FF3B30;}

table{width:100%;border-collapse:separate;border-spacing:0 6px;}
thead th{background:#E5E5EA;padding:10px;border-radius:10px 10px 0 0;font-weight:600;font-size:13px;position:sticky;top:0;z-index:10;}
tbody tr{background:white;transition:0.2s;}
tbody tr:hover{transform:translateX(2px);box-shadow:0 2px 4px rgba(0,0,0,.1);}
tbody td{padding:6px;border-top:1px solid #eee;position:relative;}

/* è¿‡æ»¤é«˜äº® */
.highlight{background:#FFEB3B;padding:2px 4px;border-radius:3px;}

/* å¼¹çª—æ ·å¼ */
.modal{
 display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);
 align-items:center;justify-content:center;z-index:1000;
}
.modal-box{
 background:white;min-width:520px;max-width:800px;border-radius:14px;
 position:absolute;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.3);
 animation:modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
 from{opacity:0;transform:scale(0.9);}
 to{opacity:1;transform:scale(1);}
}

/* æ ‡é¢˜æ å·¦ä¾§å¯æ‹–åŠ¨åŒºåŸŸ */
.modal-drag-area{
 flex:1;cursor:move;padding:5px;
 user-select:none;
}

.modal-header{
 background:#E5E5EA;padding:12px;
 font-weight:600;font-size:15px;
 border-radius:14px 14px 0 0;
 display:flex;align-items:center;gap:10px;
 justify-content:space-between;
}

.modal-body{padding:16px;max-height:70vh;overflow:auto;}
.modal-footer{padding:12px 16px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:8px;}

.check-row{
 display:flex;align-items:center;justify-content:space-between;
 border-bottom:1px solid #f0f0f0;padding:12px 0;transition:0.2s;
}
.check-row:hover{background:#f9f9f9;}
.check-label{font-size:14px;color:#111;}
.status-btn{
 padding:8px 16px;border-radius:10px;color:white;
 cursor:pointer;font-size:13px;font-weight:500;transition:0.2s;
}
.status-btn:hover{transform:scale(1.05);}
.done{background:#34C759;}
.todo{background:#FF3B30;}

/* åŠ è½½åŠ¨ç”» */
.loading{display:inline-block;width:16px;height:16px;border:2px solid #f3f3f3;border-top:2px solid #007AFF;border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* å¿«æ·é”®æç¤º */
.shortcut-hint{position:fixed;bottom:20px;right:20px;background:rgba(0,0,0,0.8);color:white;padding:10px 15px;border-radius:8px;font-size:12px;opacity:0;transition:0.3s;pointer-events:none;z-index:100;}
.shortcut-hint.show{opacity:1;}

/* Gitæäº¤è®°å½•æ ·å¼ */
.git-commit {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  margin-bottom: 12px;
  padding: 12px;
  background: #fafafa;
  transition: 0.2s;
}
.git-commit:hover {
  background: #f0f0f0;
  transform: translateY(-1px);
}
.commit-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.commit-hash {
  font-family: monospace;
  color: #007AFF;
  font-weight: 500;
}
.commit-date {
  color: #666;
  font-size: 12px;
}
.commit-author {
  color: #333;
  font-weight: 500;
}
.commit-message {
  color: #333;
  margin-bottom: 8px;
  line-height: 1.4;
}
.commit-files {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.commit-file {
  background: #e5e5ea;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  color: #333;
  cursor: pointer;
  transition: 0.2s;
  text-decoration: none;
}
.commit-file:hover {
  background: #d0d0d5;
  color: #007AFF;
}

/* Gitå›¾æ ‡æ ·å¼ */
.git-icon {
  display: inline-block;
  width: 14px;
  height: 14px;
  margin-right: 4px;
  vertical-align: middle;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
 .modal-box{min-width:90%;margin:10px;}
 .controls{flex-direction:column;align-items:stretch;}
 .controls > *{width:100%;}
 .project-input{width:100%;}
}
</style>
</head>

<body>
<h2>ä»£ç å˜æ›´æ£€æŸ¥è®°å½•è¡¨</h2>

<div class="container">
  <!-- æ“ä½œæ  -->
  <div class="controls">
    <!-- æŸ¥è¯¢åŒºåŸŸ -->
    <div class="query-section">
      <input id="u" placeholder="ç”¨æˆ·" class="user-input">
      <input id="m" type="month" class="month-input">
      <input id="projectPath" placeholder="é¡¹ç›®è·¯å¾„ï¼ˆå¯é€‰ï¼‰" class="project-input" title="è¾“å…¥Gité¡¹ç›®è·¯å¾„ä»¥å…³è”æäº¤è®°å½•">
      <button class="btn-blue" onclick="App.loadData()">åŠ è½½</button>
    </div>

    <!-- æœç´¢åŒºåŸŸ -->
    <div class="search-section">
      <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ä»»åŠ¡ã€æ–‡ä»¶æˆ–é£é™©...">
      <select id="filterStatus" class="filter-select">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        <option value="complete">å·²å®Œæˆ</option>
        <option value="incomplete">æœªå®Œæˆ</option>
      </select>
    </div>

    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
    <div class="action-section">
      <button class="btn-green" onclick="App.saveData()">ä¿å­˜</button>
      <button class="btn-orange" onclick="App.exportData()">å¯¼å‡º</button>
      <button class="btn-blue" onclick="App.addTask()">+ä»»åŠ¡</button>
      <button class="btn-blue" onclick="App.loadGitCommits()">Gitè®°å½•</button>
      <button class="btn-gray" onclick="App.clearCache()">æ¸…é™¤ç¼“å­˜</button>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <span class="save-indicator" id="saveIndicator"></span>
  </div>

  <table>
    <thead><tr>
      <th>ä»»åŠ¡</th><th>å˜æ›´å†…å®¹</th><th>æ–‡ä»¶</th><th>æµ‹è¯•</th><th>é£é™©</th><th>æ ¸å¯¹</th><th>æ“ä½œ</th>
    </tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<!-- æ ¸å¯¹å¼¹çª— -->
<div class="modal" id="modal">
  <div class="modal-box" id="modalBox">
    <div class="modal-header">
      <div class="modal-drag-area" id="modalDrag">æ ¸å¯¹æ˜ç»†</div>
      <div style="display:flex;gap:6px;">
        <button class="btn-green" id="checkSaveBtn">ä¿å­˜</button>
        <button class="btn-gray" onclick="App.closeCheck()">å–æ¶ˆ</button>
      </div>
    </div>
    <div class="modal-body" id="checkArea"></div>
    <div class="modal-footer">
      <button class="btn-blue" onclick="App.toggleAllChecks(true)">å…¨éƒ¨å®Œæˆ</button>
      <button class="btn-gray" onclick="App.toggleAllChecks(false)">å…¨éƒ¨æœªå®Œæˆ</button>
    </div>
  </div>
</div>

<!-- Gitæäº¤è®°å½•å¼¹çª— -->
<div class="modal" id="gitModal">
  <div class="modal-box" id="gitModalBox" style="max-width:1000px;">
    <div class="modal-header">
      <div class="modal-drag-area" id="gitModalDrag">Gitæäº¤è®°å½•</div>
      <button class="btn-gray" onclick="App.closeGitModal()">å…³é—­</button>
    </div>
    <div class="modal-body" id="gitContent">
      <div id="gitCommits" style="max-height:500px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<!-- å¿«æ·é”®æç¤º -->
<div class="shortcut-hint" id="shortcutHint"></div>

<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script>
// åº”ç”¨ä¸»æ¨¡å—
const App = {
  // é…ç½®
  config: {
    API: "http://localhost:8080/workcheck/api",
    DEBOUNCE_DELAY: 500,
    AUTO_SAVE_DELAY: 3000,
    CACHE_KEY: 'workCheck_cache',
    MAX_CACHE_AGE: 24 * 60 * 60 * 1000 // 24å°æ—¶
  },

  // çŠ¶æ€
  state: {
    tasks: [],
    curCheck: -1,
    originalData: null,
    autoSaveTimer: null,
    lastSaveTime: 0,
    isModified: false,
    checkTemplate: [] // åŠ¨æ€æ£€æŸ¥é¡¹æ¨¡æ¿
  },

  // åˆå§‹åŒ–
  init() {
    this.bindEvents();
    this.loadCheckTemplate(); // å…ˆåŠ è½½æ£€æŸ¥é¡¹æ¨¡æ¿
    this.loadFromCache();
    this.setupShortcuts();
    this.showShortcutHint();
  },

  // ç»‘å®šäº‹ä»¶
  bindEvents() {
    // æœç´¢é˜²æŠ–
    document.getElementById('searchInput').addEventListener('input',
      _.debounce(this.handleSearch.bind(this), this.config.DEBOUNCE_DELAY)
    );

    // çŠ¶æ€ç­›é€‰
    document.getElementById('filterStatus').addEventListener('change', this.filterTasks.bind(this));

    // è‡ªåŠ¨ä¿å­˜
    window.addEventListener('beforeunload', () => {
      if (this.state.isModified) {
        this.saveToCache();
      }
    });

    // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && this.state.isModified) {
        this.saveToCache();
      }
    });
  },

  // è®¾ç½®å¿«æ·é”®
  setupShortcuts() {
    document.addEventListener('keydown', (e) => {
      // Ctrl+S ä¿å­˜
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        this.saveData();
      }
      // Ctrl+N æ–°å»ºä»»åŠ¡
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        this.addTask();
      }
      // Esc å…³é—­å¼¹çª—
      if (e.key === 'Escape') {
        this.closeCheck();
      }
    });
  },

  // æ˜¾ç¤ºå¿«æ·é”®æç¤º
  showShortcutHint() {
    const hint = document.getElementById('shortcutHint');
    setTimeout(() => {
      hint.textContent = 'å¿«æ·é”®: Ctrl+S ä¿å­˜ | Ctrl+N æ–°å»º | Esc å…³é—­';
      hint.classList.add('show');
      setTimeout(() => hint.classList.remove('show'), 5000);
    }, 1000);
  },

  // åŠ è½½æ£€æŸ¥é¡¹æ¨¡æ¿
  async loadCheckTemplate() {
    try {
      const res = await fetch(`${this.config.API}/check-template`);
      const data = await res.json();

      if (data.success && data.checks) {
        this.state.checkTemplate = data.checks;
      } else {
        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿
        this.state.checkTemplate = [
          "ä»£ç åˆå¹¶æ˜¯å¦å®Œæˆ",
          "å†²çªæ˜¯å¦ç¡®è®¤",
          "æ ¸å¿ƒé€»è¾‘å•æµ‹è¦†ç›–",
          "é«˜é£é™©ç‚¹å¤ç›˜",
          "æ—¥å¿—çº§åˆ«åˆç†",
          "å¼‚å¸¸å…œåº•å¤„ç†",
          "paaså‚æ•°æ ¸å¯¹",
          "cmcå‚æ•°æ ¸å¯¹",
          "æ€§èƒ½æµ‹è¯•å®Œæˆ"
        ];
      }
    } catch (error) {
      console.error('åŠ è½½æ£€æŸ¥é¡¹æ¨¡æ¿å¤±è´¥:', error);
      // ä½¿ç”¨é»˜è®¤æ¨¡æ¿
      this.state.checkTemplate = [
        "ä»£ç åˆå¹¶æ˜¯å¦å®Œæˆ",
        "å†²çªæ˜¯å¦ç¡®è®¤",
        "æ ¸å¿ƒé€»è¾‘å•æµ‹è¦†ç›–",
        "é«˜é£é™©ç‚¹å¤ç›˜",
        "æ—¥å¿—çº§åˆ«åˆç†",
        "å¼‚å¸¸å…œåº•å¤„ç†",
        "paaså‚æ•°æ ¸å¯¹",
        "cmcå‚æ•°æ ¸å¯¹",
        "æ€§èƒ½æµ‹è¯•å®Œæˆ"
      ];
    }
  },

  // æœç´¢åŠŸèƒ½
  handleSearch(e) {
    const keyword = e.target.value.toLowerCase();
    this.renderTasks(this.getFilteredTasks(keyword));
  },

  // ç­›é€‰ä»»åŠ¡
  filterTasks() {
    const status = document.getElementById('filterStatus').value;
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    const tasks = this.getFilteredTasks(keyword);

    if (status === 'complete') {
      this.renderTasks(tasks.filter(t => this.isTaskComplete(t)));
    } else if (status === 'incomplete') {
      this.renderTasks(tasks.filter(t => !this.isTaskComplete(t)));
    } else {
      this.renderTasks(tasks);
    }
  },

  // è·å–è¿‡æ»¤åçš„ä»»åŠ¡
  getFilteredTasks(keyword) {
    if (!keyword) return this.state.tasks;

    return this.state.tasks.filter(task => {
      return task.taskId.toLowerCase().includes(keyword) ||
             task.change.toLowerCase().includes(keyword) ||
             task.risk.toLowerCase().includes(keyword) ||
             task.files.some(f => f.file.toLowerCase().includes(keyword));
    });
  },

  // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
  isTaskComplete(task) {
    return task.checks && task.checks.every(c => c.status === 'å®Œæˆ');
  },

  // æ¸²æŸ“ä»»åŠ¡ï¼ˆä½¿ç”¨å±€éƒ¨æ›´æ–°ï¼‰
  renderTasks(tasks) {
    console.log('renderTasks called with', tasks.length, 'tasks'); // è°ƒè¯•ä¿¡æ¯
    const tb = document.getElementById('tb');
    const fragment = document.createDocumentFragment();

    tasks.forEach((task, taskIndex) => {
      console.log(`Rendering task ${taskIndex} with ${task.files.length} files`); // è°ƒè¯•ä¿¡æ¯
      task.files.forEach((file, fileIndex) => {
        const tr = document.createElement('tr');

        // ä»»åŠ¡IDï¼ˆåªåœ¨ç¬¬ä¸€è¡Œæ˜¾ç¤ºï¼‰
        if (fileIndex === 0) {
          tr.innerHTML = `
            <td><input data-type="taskId" data-task="${taskIndex}" value="${task.taskId}" class="task-input"></td>
            <td><textarea data-type="change" data-task="${taskIndex}" class="task-textarea">${task.change}</textarea></td>
            <td>
              <div style="display:flex;gap:5px;align-items:stretch;">
                <textarea data-type="file" data-task="${taskIndex}" data-file="${fileIndex}" class="file-textarea" style="flex:1;">${file.file}</textarea>
                ${file.file ? `<button class="btn-gray" onclick="App.showFileHistory('${taskIndex}', '${fileIndex}')" title="æŸ¥çœ‹Gitå†å²" style="padding:0 8px;font-size:16px;">ğŸ“</button>` : ''}
              </div>
            </td>
            <td><input data-type="test" data-task="${taskIndex}" data-file="${fileIndex}" value="${file.test}" class="test-input"></td>
            <td><input data-type="risk" data-task="${taskIndex}" value="${task.risk}" class="risk-input"></td>
            <td>
              <button class="${this.isTaskComplete(task) ? 'btn-green' : 'btn-gray'}" onclick="App.openCheck(${taskIndex})">
                æ ¸å¯¹ (${this.getCheckCount(task)})
              </button>
            </td>
            <td>
              <button class="btn-blue" onclick="App.duplicateTask(${taskIndex})" style="margin-right:5px;">å¤åˆ¶</button>
              <button class="btn-red" onclick="App.deleteTask(${taskIndex})">åˆ é™¤</button>
              <!-- ç¬¬ä¸€è¡Œçš„+æ–‡ä»¶æŒ‰é’® -->
              <button class="btn-green" onclick="App.addFile(${taskIndex})" style="margin-left:5px;background:#ff6b35 !important;color:white !important;font-weight:bold !important;">+æ–‡ä»¶</button>
            </td>
          `;
        } else {
          // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªæ–‡ä»¶
          const isLastFile = fileIndex === task.files.length - 1;
          console.log(`Task ${taskIndex}, File ${fileIndex}/${task.files.length}, isLastFile: ${isLastFile}`); // è°ƒè¯•ä¿¡æ¯
          tr.innerHTML = `
            <td></td>
            <td></td>
            <td>
              <div style="display:flex;gap:5px;align-items:stretch;">
                <textarea data-type="file" data-task="${taskIndex}" data-file="${fileIndex}" class="file-textarea" style="flex:1;">${file.file}</textarea>
                ${file.file ? `<button class="btn-gray" onclick="App.showFileHistory('${taskIndex}', '${fileIndex}')" title="æŸ¥çœ‹Gitå†å²" style="padding:0 8px;font-size:16px;">ğŸ“</button>` : ''}
              </div>
            </td>
            <td><input data-type="test" data-task="${taskIndex}" data-file="${fileIndex}" value="${file.test}" class="test-input"></td>
            <td></td>
            <td>
              <button class="btn-red" onclick="App.deleteFile(${taskIndex}, ${fileIndex})">åˆ æ–‡ä»¶</button>
              <!-- ä¸´æ—¶è°ƒè¯•ï¼šè®©æ‰€æœ‰æ–‡ä»¶è¡Œéƒ½æ˜¾ç¤º+æ–‡ä»¶æŒ‰é’® -->
              <button class="btn-green" onclick="App.addFile(${taskIndex})" style="margin-left:5px;background:#ff6b35 !important;color:white !important;font-weight:bold !important;">+æ–‡ä»¶</button>
              <!-- åŸå§‹é€»è¾‘ï¼š${isLastFile ? `<button class="btn-green" onclick="App.addFile(${taskIndex})" style="margin-left:5px;">+æ–‡ä»¶</button>` : '<!-- not last file -->'} -->
            </td>
            <td></td>
          `;
        }

        fragment.appendChild(tr);
      });
    });

    tb.innerHTML = '';
    tb.appendChild(fragment);

    // é‡æ–°ç»‘å®šè¾“å…¥äº‹ä»¶
    this.bindInputEvents();

    // é«˜äº®æœç´¢å…³é”®è¯
    if (document.getElementById('searchInput').value) {
      this.highlightKeyword(document.getElementById('searchInput').value);
    }
  },

  // è·å–æ ¸å¯¹å®Œæˆæ•°
  getCheckCount(task) {
    // å¦‚æœä»»åŠ¡æ²¡æœ‰checksï¼Œæ·»åŠ é»˜è®¤çš„
    if (!task.checks || !Array.isArray(task.checks)) {
      task.checks = this.getDefaultChecks();
    }
    const completed = task.checks.filter(c => c.status === 'å®Œæˆ').length;
    return `${completed}/${task.checks.length}`;
  },

  // é«˜äº®å…³é”®è¯
  highlightKeyword(keyword) {
    if (!keyword) return;
    const regex = new RegExp(`(${keyword})`, 'gi');
    document.querySelectorAll('td').forEach(td => {
      if (td.querySelector('input') || td.querySelector('textarea')) return;
      const text = td.textContent;
      if (text.toLowerCase().includes(keyword.toLowerCase())) {
        td.innerHTML = text.replace(regex, '<span class="highlight">$1</span>');
      }
    });
  },

  // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
  bindInputEvents() {
    const tb = document.getElementById('tb');

    tb.addEventListener('input', _.debounce((e) => {
      const el = e.target;
      const { type, task, file } = el.dataset;

      if (this.validateInput(el)) {
        const taskIndex = parseInt(task);
        const fileIndex = file ? parseInt(file) : null;

        if (fileIndex !== null) {
          this.state.tasks[taskIndex].files[fileIndex][type] = el.value;
        } else {
          this.state.tasks[taskIndex][type] = el.value;
        }

        this.markModified();
        this.autoResizeTextarea(el);
      }
    }, 300));
  },

  // è¾“å…¥éªŒè¯
  validateInput(el) {
    const value = el.value.trim();

    // å¿…å¡«å­—æ®µéªŒè¯
    if (el.dataset.type === 'taskId' && !value) {
      el.classList.add('error');
      this.showError('ä»»åŠ¡IDä¸èƒ½ä¸ºç©º');
      return false;
    }

    // é£é™©ç­‰çº§éªŒè¯
    if (el.dataset.type === 'risk' && value) {
      const validRisks = ['ä½', 'ä¸­', 'é«˜'];
      if (!validRisks.includes(value)) {
        el.classList.add('error');
        this.showError('é£é™©ç­‰çº§è¯·è¾“å…¥ï¼šä½ã€ä¸­ã€é«˜');
        return false;
      }
    }

    el.classList.remove('error');
    return true;
  },

  // æ˜¾ç¤ºé”™è¯¯æç¤º
  showError(message) {
    const indicator = document.getElementById('saveIndicator');
    indicator.textContent = message;
    indicator.className = 'save-indicator error';
    setTimeout(() => {
      indicator.textContent = '';
      indicator.className = 'save-indicator';
    }, 3000);
  },

  // æ ‡è®°å·²ä¿®æ”¹
  markModified() {
    this.state.isModified = true;
    clearTimeout(this.state.autoSaveTimer);
    this.state.autoSaveTimer = setTimeout(() => {
      this.saveToCache();
      this.showSaveStatus('å·²è‡ªåŠ¨ä¿å­˜åˆ°ç¼“å­˜', 'success');
    }, this.config.AUTO_SAVE_DELAY);
  },

  // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
  autoResizeTextarea(el) {
    if (el.tagName !== 'TEXTAREA') return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  },

  // åŠ è½½æ•°æ®
  async loadData() {
    const u = document.getElementById('u');
    const m = document.getElementById('m');

    if (!u.value.trim() || !m.value.trim()) {
      this.showError('è¯·å¡«å†™ç”¨æˆ·å’Œæœˆä»½ï¼');
      return;
    }

    this.showSaveStatus('åŠ è½½ä¸­...', 'saving');

    try {
      const res = await fetch(`${this.config.API}/load?user=${u.value.trim()}&month=${m.value}`);
      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || 'åŠ è½½å¤±è´¥');
      }

      this.state.tasks = data.tasks || [];
      // è¿ç§»å’Œç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½æœ‰æ­£ç¡®æ ¼å¼çš„checkså­—æ®µ
      this.state.tasks.forEach(task => {
        task.checks = this.migrateChecksFormat(task.checks);
      });

      this.state.originalData = JSON.parse(JSON.stringify(this.state.tasks));
      this.state.isModified = false;

      this.renderTasks(this.state.tasks);
      this.showSaveStatus('åŠ è½½æˆåŠŸ', 'success');
    } catch (error) {
      this.showError('åŠ è½½å¤±è´¥ï¼š' + error.message);
    }
  },

  // ä¿å­˜æ•°æ®
  async saveData() {
    if (!this.state.tasks.length) {
      this.showError('æ²¡æœ‰æ•°æ®å¯ä¿å­˜');
      return;
    }

    const u = document.getElementById('u');
    const m = document.getElementById('m');

    if (!u.value.trim() || !m.value.trim()) {
      this.showError('è¯·å¡«å†™ç”¨æˆ·å’Œæœˆä»½ï¼');
      return;
    }

    this.showSaveStatus('ä¿å­˜ä¸­...', 'saving');

    try {
      const res = await fetch(`${this.config.API}/save?user=${encodeURIComponent(u.value.trim())}&month=${encodeURIComponent(m.value.trim())}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(this.state.tasks)
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
      }

      this.state.isModified = false;
      this.state.lastSaveTime = Date.now();
      this.saveToCache();
      // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä»¥æ›´æ–°æ ¸å¯¹æŒ‰é’®çŠ¶æ€
      this.renderTasks(this.state.tasks);
      this.showSaveStatus('ä¿å­˜æˆåŠŸ', 'success');
    } catch (error) {
      this.showError('ä¿å­˜å¤±è´¥ï¼š' + error.message);
    }
  },

  // å¯¼å‡ºæ•°æ®
  exportData() {
    if (!this.state.tasks.length) {
      this.showError('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
      return;
    }

    // CSVæ ¼å¼
    const csvContent = this.convertToCSV(this.state.tasks);
    this.downloadFile(csvContent, `å˜æ›´æ£€æŸ¥è¡¨_${new Date().toLocaleDateString()}.csv`, 'text/csv');
    this.showSaveStatus('å¯¼å‡ºæˆåŠŸ', 'success');
  },

  // è½¬æ¢ä¸ºCSV
  convertToCSV(tasks) {
    const headers = ['ä»»åŠ¡ID', 'å˜æ›´å†…å®¹', 'æ–‡ä»¶', 'æµ‹è¯•', 'é£é™©', 'æ ¸å¯¹çŠ¶æ€'];
    const rows = [headers];

    tasks.forEach(task => {
      task.files.forEach(file => {
        rows.push([
          task.taskId,
          task.change,
          file.file,
          file.test,
          task.risk,
          this.getCheckCount(task)
        ]);
      });
    });

    return rows.map(row =>
      row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')
    ).join('\n');
  },

  // ä¸‹è½½æ–‡ä»¶
  downloadFile(content, filename, type) {
    const blob = new Blob(['\ufeff' + content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  },

  // æ·»åŠ ä»»åŠ¡
  addTask() {
    // ç”Ÿæˆå”¯ä¸€çš„ä»»åŠ¡ID
    const maxId = this.state.tasks.reduce((max, task) => {
      const match = task.taskId.match(/S(\d+)/);
      if (match) {
        const id = parseInt(match[1]);
        return id > max ? id : max;
      }
      return max;
    }, 0);

    const newTask = {
      taskId: "S" + (maxId + 1).toString().padStart(5, "0"),
      change: "",
      risk: "",
      files: [{file: "", test: ""}],
      checks: this.getDefaultChecks()
    };

    this.state.tasks.push(newTask);
    this.renderTasks(this.state.tasks);
    this.markModified();
    this.showSaveStatus('å·²æ·»åŠ æ–°ä»»åŠ¡', 'success');
  },

  // å¤åˆ¶ä»»åŠ¡
  duplicateTask(index) {
    const originalTask = this.state.tasks[index];

    // ç”Ÿæˆå”¯ä¸€çš„å¤åˆ¶ä»»åŠ¡ID
    let suffix = 1;
    let newTaskId = originalTask.taskId + '-copy';

    // ç¡®ä¿IDå”¯ä¸€
    while (this.state.tasks.some(t => t.taskId === newTaskId)) {
      newTaskId = originalTask.taskId + '-copy' + suffix;
      suffix++;
    }

    const newTask = {
      ...originalTask,
      taskId: newTaskId,
      files: originalTask.files.map(f => ({...f})),
      checks: originalTask.checks.map(c => ({...c}))
    };

    this.state.tasks.splice(index + 1, 0, newTask);
    this.renderTasks(this.state.tasks);
    this.markModified();
    this.showSaveStatus('å·²å¤åˆ¶ä»»åŠ¡', 'success');
  },

  // åˆ é™¤ä»»åŠ¡
  deleteTask(index) {
    if (confirm('ç¡®è®¤åˆ é™¤è¯¥ä»»åŠ¡ï¼Ÿ')) {
      this.state.tasks.splice(index, 1);
      this.renderTasks(this.state.tasks);
      this.markModified();
      this.showSaveStatus('ä»»åŠ¡å·²åˆ é™¤', 'success');
    }
  },

  // åˆ é™¤æ–‡ä»¶
  deleteFile(taskIndex, fileIndex) {
    if (confirm('ç¡®è®¤åˆ é™¤è¯¥æ–‡ä»¶ï¼Ÿ')) {
      this.state.tasks[taskIndex].files.splice(fileIndex, 1);
      if (!this.state.tasks[taskIndex].files.length) {
        this.deleteTask(taskIndex);
      } else {
        this.renderTasks(this.state.tasks);
        this.markModified();
      }
    }
  },

  // æ·»åŠ æ–‡ä»¶
  addFile(taskIndex) {
    console.log(`Adding file to task ${taskIndex}`); // è°ƒè¯•ä¿¡æ¯
    this.state.tasks[taskIndex].files.push({
      file: "",
      test: ""
    });
    console.log('New files count:', this.state.tasks[taskIndex].files.length); // è°ƒè¯•ä¿¡æ¯
    this.renderTasks(this.state.tasks);
    this.markModified();
  },

  // è·å–é»˜è®¤æ£€æŸ¥é¡¹
  getDefaultChecks() {
    // ä½¿ç”¨åŠ¨æ€åŠ è½½çš„æ¨¡æ¿ï¼Œå¦‚æœæ¨¡æ¿ä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
    const template = this.state.checkTemplate.length > 0 ? this.state.checkTemplate : [
      "ä»£ç åˆå¹¶æ˜¯å¦å®Œæˆ",
      "å†²çªæ˜¯å¦ç¡®è®¤",
      "æ ¸å¿ƒé€»è¾‘å•æµ‹è¦†ç›–",
      "é«˜é£é™©ç‚¹å¤ç›˜",
      "æ—¥å¿—çº§åˆ«åˆç†",
      "å¼‚å¸¸å…œåº•å¤„ç†",
      "paaså‚æ•°æ ¸å¯¹",
      "cmcå‚æ•°æ ¸å¯¹",
      "æ€§èƒ½æµ‹è¯•å®Œæˆ"
    ];

    return template.map((item, index) => ({
      checkItem: item,
      status: "æœªå®Œæˆ",
      sortOrder: index
    }));
  },

  // è¿ç§»æ—§æ ¼å¼çš„æ£€æŸ¥é¡¹æ•°æ®
  migrateChecksFormat(checks) {
    if (!Array.isArray(checks)) return this.getDefaultChecks();

    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ ¼å¼ï¼ˆç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¯¹è±¡ï¼‰
    if (checks.length > 0 && typeof checks[0] === 'object' && checks[0].checkItem) {
      return checks;
    }

    // æ—§æ ¼å¼ï¼š[["æ£€æŸ¥é¡¹", "çŠ¶æ€"], ...]
    if (checks.length > 0 && Array.isArray(checks[0])) {
      return checks.map((check, index) => ({
        checkItem: check[0],
        status: check[1] || 'æœªå®Œæˆ',
        sortOrder: index
      }));
    }

    // é»˜è®¤è¿”å›æ–°æ ¼å¼
    return this.getDefaultChecks();
  },

  // æ‰“å¼€æ ¸å¯¹å¼¹çª—
  openCheck(taskIndex) {
    this.state.curCheck = taskIndex;
    const task = this.state.tasks[taskIndex];

    // ç¡®ä¿ä»»åŠ¡æœ‰checkså­—æ®µ
    if (!task.checks || !Array.isArray(task.checks)) {
      task.checks = this.getDefaultChecks();
    }

    const modal = document.getElementById('modal');
    modal.style.display = 'flex';
    this.centerModal();
    this.renderChecks();
  },

  // å…³é—­æ ¸å¯¹å¼¹çª—
  closeCheck() {
    const modal = document.getElementById('modal');
    modal.style.display = 'none';
    if (this.state.curCheck >= 0) {
      this.markModified();
      // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä»¥æ›´æ–°æ ¸å¯¹æŒ‰é’®çŠ¶æ€
      this.renderTasks(this.state.tasks);
    }
  },

  // æ¸²æŸ“æ£€æŸ¥é¡¹
  renderChecks() {
    const checkArea = document.getElementById('checkArea');
    const task = this.state.tasks[this.state.curCheck];
    const checks = task.checks;

    checkArea.innerHTML = checks.map((check, index) => `
      <div class="check-row">
        <div class="check-label">${check.checkItem}</div>
        <button class="status-btn ${check.status === 'å®Œæˆ' ? 'done' : 'todo'}"
                onclick="App.toggleCheck(${index})">
          ${check.status}
        </button>
      </div>
    `).join('');
  },

  // åˆ‡æ¢æ£€æŸ¥é¡¹çŠ¶æ€
  toggleCheck(index) {
    const check = this.state.tasks[this.state.curCheck].checks[index];
    check.status = check.status === 'å®Œæˆ' ? 'æœªå®Œæˆ' : 'å®Œæˆ';
    this.renderChecks();
    this.markModified();
  },

  // å…¨éƒ¨åˆ‡æ¢
  toggleAllChecks(complete) {
    const task = this.state.tasks[this.state.curCheck];
    task.checks.forEach(check => {
      check.status = complete ? 'å®Œæˆ' : 'æœªå®Œæˆ';
    });
    this.renderChecks();
    this.markModified();
  },

  // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
  showSaveStatus(message, type) {
    const indicator = document.getElementById('saveIndicator');
    indicator.textContent = message;
    indicator.className = `save-indicator ${type}`;
  },

  // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
  saveToCache() {
    const cache = {
      tasks: this.state.tasks,
      timestamp: Date.now(),
      user: document.getElementById('u').value,
      month: document.getElementById('m').value
    };

    try {
      localStorage.setItem(this.config.CACHE_KEY, JSON.stringify(cache));
    } catch (e) {
      console.error('ç¼“å­˜ä¿å­˜å¤±è´¥:', e);
    }
  },

  // ä»æœ¬åœ°ç¼“å­˜åŠ è½½
  loadFromCache() {
    try {
      const cacheStr = localStorage.getItem(this.config.CACHE_KEY);
      if (!cacheStr) return;

      const cache = JSON.parse(cacheStr);
      if (Date.now() - cache.timestamp > this.config.MAX_CACHE_AGE) {
        this.clearCache();
        return;
      }

      this.state.tasks = cache.tasks || [];
      // ç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½æœ‰checkså­—æ®µ
      this.state.tasks.forEach(task => {
        if (!task.checks || !Array.isArray(task.checks)) {
          task.checks = this.getDefaultChecks();
        }
      });

      document.getElementById('u').value = cache.user || '';
      document.getElementById('m').value = cache.month || '';

      if (this.state.tasks.length) {
        this.renderTasks(this.state.tasks);
        this.showSaveStatus('å·²ä»ç¼“å­˜æ¢å¤æ•°æ®', 'success');
      }
    } catch (e) {
      console.error('ç¼“å­˜åŠ è½½å¤±è´¥:', e);
      this.clearCache();
    }
  },

  // æ¸…é™¤ç¼“å­˜
  clearCache() {
    localStorage.removeItem(this.config.CACHE_KEY);
    this.showSaveStatus('ç¼“å­˜å·²æ¸…é™¤', 'success');
  },

  // å±…ä¸­å¼¹çª—
  centerModal() {
    const box = document.getElementById('modalBox');
    box.style.left = "50%";
    box.style.top = "50%";
    box.style.transform = "translate(-50%, -50%)";
  },

  // Gitç›¸å…³æ–¹æ³•
  async loadGitCommits() {
    const u = document.getElementById('u');
    const m = document.getElementById('m');
    const projectPath = document.getElementById('projectPath');

    if (!u.value.trim() || !m.value.trim()) {
      this.showError('è¯·å¡«å†™ç”¨æˆ·å’Œæœˆä»½ï¼');
      return;
    }

    if (!projectPath.value.trim()) {
      this.showError('è¯·å¡«å†™é¡¹ç›®è·¯å¾„ï¼');
      return;
    }

    try {
      const response = await fetch(`${this.config.API}/git/commits?userName=${encodeURIComponent(u.value.trim())}&month=${m.value.trim()}&projectPath=${encodeURIComponent(projectPath.value.trim())}`);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'åŠ è½½Gitæäº¤è®°å½•å¤±è´¥');
      }

      this.showGitModal(data.commits, data.remoteUrl);
    } catch (error) {
      this.showError('åŠ è½½Gitæäº¤è®°å½•å¤±è´¥ï¼š' + error.message);
    }
  },

  showGitModal(commits, remoteUrl) {
    const modal = document.getElementById('gitModal');
    const gitContent = document.getElementById('gitCommits');

    let html = '';

    if (commits.length === 0) {
      html = '<p style="text-align:center;color:#666;padding:20px;">è¯¥æœˆä»½æ²¡æœ‰æ‰¾åˆ°Gitæäº¤è®°å½•</p>';
    } else {
      html = commits.map(commit => {
        const filesHtml = commit.files.map(file => {
          // ç”Ÿæˆæ–‡ä»¶é“¾æ¥ï¼Œä¼˜å…ˆä½¿ç”¨è¿œç¨‹URL
          let fileUrl = '';
          if (remoteUrl) {
            // è½¬æ¢ä¸ºblob URLæ ¼å¼
            const baseUrl = remoteUrl.endsWith('.git') ? remoteUrl.slice(0, -4) : remoteUrl;
            fileUrl = `${baseUrl}/blob/${commit.hash}/${file}`;
          }

          return `<a href="${fileUrl}" target="_blank" class="commit-file" title="ç‚¹å‡»æŸ¥çœ‹æ–‡ä»¶">${file}</a>`;
        }).join('');

        return `
          <div class="git-commit">
            <div class="commit-header">
              <span>
                <span class="commit-hash">${commit.hash.substring(0, 7)}</span>
                <span class="commit-author">${commit.author}</span>
              </span>
              <span class="commit-date">${commit.date}</span>
            </div>
            <div class="commit-message">${commit.message}</div>
            <div class="commit-files">${filesHtml}</div>
          </div>
        `;
      }).join('');
    }

    gitContent.innerHTML = html;
    modal.style.display = 'flex';

    // å±…ä¸­æ˜¾ç¤º
    this.centerGitModal();
  },

  closeGitModal() {
    document.getElementById('gitModal').style.display = 'none';
  },

  centerGitModal() {
    const box = document.getElementById('gitModalBox');
    box.style.position = 'fixed';
    box.style.left = "50%";
    box.style.top = "50%";
    box.style.transform = "translate(-50%, -50%)";
    box.style.margin = "0";
  },

  // æ˜¾ç¤ºæ–‡ä»¶Gitå†å²
  async showFileHistory(taskIndex, fileIndex) {
    const task = this.state.tasks[taskIndex];
    const file = task.files[fileIndex];
    const fileName = file.file;

    if (!fileName) {
      this.showError('æ–‡ä»¶è·¯å¾„ä¸ºç©º');
      return;
    }

    const u = document.getElementById('u');
    const m = document.getElementById('m');
    const projectPath = document.getElementById('projectPath');

    if (!projectPath.value.trim()) {
      this.showError('è¯·å¡«å†™é¡¹ç›®è·¯å¾„ï¼');
      return;
    }

    try {
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      let url = `${this.config.API}/git/file-commits?fileName=${encodeURIComponent(fileName)}&projectPath=${encodeURIComponent(projectPath.value.trim())}`;

      // åªæœ‰å½“ç”¨æˆ·åä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
      if (u.value.trim()) {
        url += `&userName=${encodeURIComponent(u.value.trim())}`;
      }

      // æ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°
      const startDate = document.getElementById('historyStartDate')?.value;
      const endDate = document.getElementById('historyEndDate')?.value;

      if (startDate && endDate) {
        url += `&startDate=${startDate}&endDate=${endDate}`;
      } else if (m.value.trim()) {
        url += `&month=${m.value.trim()}`;
      }

      const response = await fetch(url);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'è·å–æ–‡ä»¶Gitå†å²å¤±è´¥');
      }

      this.showFileHistoryModal(fileName, data.commits, data.remoteUrl, startDate, endDate, data.defaultBranch);
    } catch (error) {
      this.showError('è·å–æ–‡ä»¶Gitå†å²å¤±è´¥ï¼š' + error.message);
    }
  },

  // æ˜¾ç¤ºæ–‡ä»¶å†å²å¼¹çª—
  showFileHistoryModal(fileName, commits, remoteUrl, startDate, endDate, defaultBranch) {
    // åˆ›å»ºæˆ–ä½¿ç”¨ç°æœ‰çš„æ¨¡æ€æ¡†
    let modal = document.getElementById('fileHistoryModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'fileHistoryModal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-box" style="max-width:900px;">
          <div class="modal-header">
            <div class="modal-drag-area">æ–‡ä»¶å†å²ï¼š${fileName}</div>
            <button class="btn-gray" onclick="App.closeFileHistoryModal()">å…³é—­</button>
          </div>
          <div class="modal-body" id="fileHistoryContent" style="max-height:60vh;overflow-y:auto;">
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    const content = document.getElementById('fileHistoryContent');

    if (commits.length === 0) {
      const timeRange = (startDate && endDate) ? `åœ¨ ${startDate} è‡³ ${endDate}` : 'åœ¨æŒ‡å®šæ—¶é—´';
      content.innerHTML = `<p style="text-align:center;color:#666;padding:20px;">è¯¥æ–‡ä»¶${timeRange}æ²¡æœ‰æäº¤è®°å½•</p>`;
    } else {
      // ç”Ÿæˆæ—¶é—´èŒƒå›´ç­›é€‰é€‰é¡¹çš„HTML
      const filterHtml = `
        <div style="padding:10px;background:#f5f5f5;margin-bottom:10px;border-radius:4px;">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <span>æ—¶é—´èŒƒå›´ç­›é€‰ï¼š</span>
            <input type="date" id="historyStartDate" value="${startDate || ''}" placeholder="å¼€å§‹æ—¥æœŸ" style="padding:4px;">
            <span>è‡³</span>
            <input type="date" id="historyEndDate" value="${endDate || ''}" placeholder="ç»“æŸæ—¥æœŸ" style="padding:4px;">
            <button class="btn-blue" onclick="App.refreshFileHistory('${fileName}')" style="padding:4px 8px;">åˆ·æ–°</button>
            <button class="btn-gray" onclick="App.clearHistoryFilter()" style="padding:4px 8px;">æ¸…é™¤</button>
          </div>
        </div>
      `;

      let commitsHtml = commits.map(commit => {
        // ä½¿ç”¨æ–°çš„URLç”Ÿæˆå‡½æ•°
        const fileUrl = this.generateGitUrl(remoteUrl, commit.hash, fileName);

        return `
          <div class="git-commit">
            <div class="commit-header">
              <span>
                <span class="commit-hash">${commit.hash.substring(0, 7)}</span>
                <span class="commit-author">${commit.author}</span>
              </span>
              <span class="commit-date">${commit.date}</span>
            </div>
            <div class="commit-message">${commit.message}</div>
            <div style="margin-top:8px;">
              ${fileUrl ?
                `<a href="${fileUrl}" target="_blank" class="btn-blue" style="font-size:12px;padding:4px 8px;text-decoration:none;" title="åœ¨è¿œç¨‹ä»“åº“ä¸­æŸ¥çœ‹æ–‡ä»¶">
                  æŸ¥çœ‹æ–‡ä»¶ â†’
                </a>
                <a href="${this.generateGitUrl(remoteUrl, commit.hash, '') || '#'}" target="_blank" class="btn-gray" style="font-size:12px;padding:4px 8px;text-decoration:none;margin-left:5px;" title="æŸ¥çœ‹æäº¤è¯¦æƒ…">
                  æŸ¥çœ‹æäº¤ â†’
                </a>
                <button class="btn-green" style="font-size:12px;padding:4px 8px;margin-left:5px;" onclick="App.showFileDiff('${commit.hash}', '${encodeURIComponent(fileName)}')" title="æŸ¥çœ‹ä»£ç å·®å¼‚">
                  æŸ¥çœ‹å·®å¼‚ â†’
                </button>` :
                '<span style="color:#999;font-size:12px;">æ— è¿œç¨‹ä»“åº“é“¾æ¥</span>'
              }
              <div id="diff-${commit.hash.substring(0, 7)}" style="display:none;margin-top:10px;"></div>
            </div>
          </div>
        `;
      }).join('');

      content.innerHTML = filterHtml + commitsHtml;
    }

    modal.style.display = 'flex';
    // å±…ä¸­æ˜¾ç¤º
    const box = modal.querySelector('.modal-box');
    box.style.position = 'fixed';
    box.style.left = "50%";
    box.style.top = "50%";
    box.style.transform = "translate(-50%, -50%)";
  },

  // ç”ŸæˆGit URL
  generateGitUrl(remoteUrl, commitHash, fileName) {
    if (!remoteUrl || !commitHash || !fileName) {
      return null;
    }

    // è§„èŒƒåŒ–è¿œç¨‹URL
    let baseUrl = remoteUrl;
    if (baseUrl.endsWith('.git')) {
      baseUrl = baseUrl.slice(0, -4);
    }

    // ç¡®ä¿æ–‡ä»¶è·¯å¾„æ ¼å¼æ­£ç¡®
    // ç§»é™¤å¼€å¤´çš„ ./ æˆ– ../
    let normalizedFilePath = fileName.replace(/^\.\//g, '').replace(/^\.\.\//g, '');

    // å¤„ç†ç›¸å¯¹è·¯å¾„ - ç¡®ä¿ä½¿ç”¨æ­£æ–œæ 
    normalizedFilePath = normalizedFilePath.replace(/\\/g, '/');

    // è¯†åˆ«Gitå¹³å°å¹¶ç”Ÿæˆç›¸åº”URL
    try {
      if (baseUrl.includes('github.com')) {
        // GitHub URLæ ¼å¼
        return `${baseUrl}/blob/${commitHash}/${normalizedFilePath}`;
      } else if (baseUrl.includes('gitlab.com')) {
        // GitLab URLæ ¼å¼
        return `${baseUrl}/-/blob/${commitHash}/${normalizedFilePath}`;
      } else if (baseUrl.includes('gitee.com')) {
        // Gitee URLæ ¼å¼
        return `${baseUrl}/blob/${commitHash}/${normalizedFilePath}`;
      } else if (baseUrl.includes('bitbucket.org')) {
        // Bitbucket URLæ ¼å¼
        return `${baseUrl}/src/${commitHash}/${normalizedFilePath}`;
      } else if (baseUrl.includes('coding.net')) {
        // è…¾è®¯äº‘å¼€å‘è€…å¹³å°
        return `${baseUrl}/blob/${commitHash}/${normalizedFilePath}`;
      } else if (baseUrl.includes('git.tencent.com')) {
        // è…¾è®¯å·¥èœ‚
        return `${baseUrl}/blob/${commitHash}/${normalizedFilePath}`;
      } else {
        // é»˜è®¤æ ¼å¼ï¼Œå°è¯•é€šç”¨çš„ tree è·¯å¾„
        return `${baseUrl}/tree/${commitHash}/${normalizedFilePath}`;
      }
    } catch (e) {
      console.error('ç”ŸæˆGit URLå¤±è´¥:', e);
      return null;
    }
  },

  // å…³é—­æ–‡ä»¶å†å²å¼¹çª—
  closeFileHistoryModal() {
    const modal = document.getElementById('fileHistoryModal');
    if (modal) {
      modal.style.display = 'none';
    }
  },

  // åˆ·æ–°æ–‡ä»¶å†å²ï¼ˆä½¿ç”¨æ–°çš„æ—¶é—´èŒƒå›´ï¼‰
  async refreshFileHistory(fileName) {
    const startDate = document.getElementById('historyStartDate').value;
    const endDate = document.getElementById('historyEndDate').value;
    const u = document.getElementById('u');
    const m = document.getElementById('m');
    const projectPath = document.getElementById('projectPath');

    if (!projectPath.value.trim()) {
      this.showError('è¯·å¡«å†™é¡¹ç›®è·¯å¾„ï¼');
      return;
    }

    try {
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      let url = `${this.config.API}/git/file-commits?fileName=${encodeURIComponent(fileName)}&projectPath=${encodeURIComponent(projectPath.value.trim())}`;

      // åªæœ‰å½“ç”¨æˆ·åä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
      if (u.value.trim()) {
        url += `&userName=${encodeURIComponent(u.value.trim())}`;
      }

      // æ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°
      if (startDate && endDate) {
        url += `&startDate=${startDate}&endDate=${endDate}`;
      } else if (m.value.trim()) {
        url += `&month=${m.value.trim()}`;
      }

      const response = await fetch(url);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'è·å–æ–‡ä»¶Gitå†å²å¤±è´¥');
      }

      // é‡æ–°åŠ è½½å†…å®¹ï¼Œä¿æŒå¼¹çª—æ‰“å¼€
      const content = document.getElementById('fileHistoryContent');

      if (data.commits.length === 0) {
        const timeRange = (startDate && endDate) ? `åœ¨ ${startDate} è‡³ ${endDate}` : 'åœ¨æŒ‡å®šæ—¶é—´';
        content.innerHTML = `
          <div style="padding:10px;background:#f5f5f5;margin-bottom:10px;border-radius:4px;">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <span>æ—¶é—´èŒƒå›´ç­›é€‰ï¼š</span>
              <input type="date" id="historyStartDate" value="${startDate || ''}" placeholder="å¼€å§‹æ—¥æœŸ" style="padding:4px;">
              <span>è‡³</span>
              <input type="date" id="historyEndDate" value="${endDate || ''}" placeholder="ç»“æŸæ—¥æœŸ" style="padding:4px;">
              <button class="btn-blue" onclick="App.refreshFileHistory('${fileName}')" style="padding:4px 8px;">åˆ·æ–°</button>
              <button class="btn-gray" onclick="App.clearHistoryFilter()" style="padding:4px 8px;">æ¸…é™¤</button>
            </div>
          </div>
          <p style="text-align:center;color:#666;padding:20px;">è¯¥æ–‡ä»¶${timeRange}æ²¡æœ‰æäº¤è®°å½•</p>
        `;
      } else {
        // å¤ç”¨ä¹‹å‰çš„HTMLç”Ÿæˆé€»è¾‘
        this.updateCommitsInModal(fileName, data.commits, data.remoteUrl, startDate, endDate);
      }
    } catch (error) {
      this.showError('åˆ·æ–°å¤±è´¥ï¼š' + error.message);
    }
  },

  // æ¸…é™¤æ—¶é—´ç­›é€‰ï¼Œä½¿ç”¨æœˆä»½æŸ¥è¯¢
  async clearHistoryFilter() {
    document.getElementById('historyStartDate').value = '';
    document.getElementById('historyEndDate').value = '';

    // è·å–å½“å‰çš„æ–‡ä»¶åï¼ˆä»æ ‡é¢˜ä¸­æå–ï¼‰
    const modal = document.getElementById('fileHistoryModal');
    const title = modal.querySelector('.modal-drag-area').textContent;
    const fileName = title.replace('æ–‡ä»¶å†å²ï¼š', '');

    // ä½¿ç”¨åŸå§‹çš„showFileHistoryé€»è¾‘ï¼Œä½†ä¸ä¼ å…¥æ—¥æœŸ
    await this.refreshFileHistory(fileName);
  },

  // æ˜¾ç¤ºæ–‡ä»¶å·®å¼‚
  async showFileDiff(commitHash, encodedFileName) {
    const fileName = decodeURIComponent(encodedFileName);
    const projectPath = document.getElementById('projectPath');

    if (!projectPath.value.trim()) {
      this.showError('è¯·å¡«å†™é¡¹ç›®è·¯å¾„ï¼');
      return;
    }

    const diffContainer = document.getElementById(`diff-${commitHash.substring(0, 7)}`);

    // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œåˆ™åˆ‡æ¢æ˜¾ç¤º/éšè—
    if (diffContainer.dataset.loaded === 'true') {
      diffContainer.style.display = diffContainer.style.display === 'none' ? 'block' : 'none';
      return;
    }

    // æ˜¾ç¤ºåŠ è½½ä¸­
    diffContainer.innerHTML = '<div style="text-align:center;padding:10px;color:#666;">æ­£åœ¨åŠ è½½ä»£ç å·®å¼‚...</div>';
    diffContainer.style.display = 'block';

    try {
      const response = await fetch(`${this.config.API}/git/file-diff?commitHash=${commitHash}&filePath=${encodeURIComponent(fileName)}&projectPath=${encodeURIComponent(projectPath.value.trim())}`);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'è·å–ä»£ç å·®å¼‚å¤±è´¥');
      }

      // æ ¼å¼åŒ–å·®å¼‚æ˜¾ç¤º
      const formattedDiff = this.formatDiff(data.content);
      diffContainer.innerHTML = formattedDiff;
      diffContainer.dataset.loaded = 'true';
    } catch (error) {
      diffContainer.innerHTML = `<div style="color:red;padding:10px;">é”™è¯¯ï¼š${error.message}</div>`;
    }
  },

  // æ ¼å¼åŒ–å·®å¼‚å†…å®¹
  formatDiff(diffContent) {
    if (!diffContent) return '<div style="color:#999;">æ— å·®å¼‚å†…å®¹</div>';

    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ–‡ä»¶
    if (diffContent.includes('+++ æ–°åˆ›å»ºçš„æ–‡ä»¶å†…å®¹ +++')) {
      const content = diffContent.replace('+++ æ–°åˆ›å»ºçš„æ–‡ä»¶å†…å®¹ +++\n', '');
      return `
        <div style="background:#f0fff0;padding:10px;border-left:4px solid #28a745;margin-bottom:10px;">
          <strong style="color:#28a745;">æ–°åˆ›å»ºçš„æ–‡ä»¶</strong>
        </div>
        <pre style="background:#f8f9fa;padding:10px;overflow-x:auto;max-height:400px;font-family:monospace;font-size:12px;line-height:1.4;">${this.escapeHtml(content)}</pre>
      `;
    }

    // å¤„ç†diffæ ¼å¼
    const lines = diffContent.split('\n');
    let html = '<pre style="background:#f8f9fa;padding:10px;overflow-x:auto;max-height:400px;font-family:monospace;font-size:12px;line-height:1.4;">';

    for (const line of lines) {
      let className = '';
      let prefix = '';

      if (line.startsWith('diff --git')) {
        className = 'diff-header';
        html += `<div style="color:#6c757d;font-weight:bold;">${this.escapeHtml(line)}</div>`;
      } else if (line.startsWith('index ')) {
        className = 'diff-index';
        html += `<div style="color:#6c757d;">${this.escapeHtml(line)}</div>`;
      } else if (line.startsWith('---') || line.startsWith('+++')) {
        className = 'diff-file';
        html += `<div style="color:#6c757d;font-weight:bold;">${this.escapeHtml(line)}</div>`;
      } else if (line.startsWith('@@')) {
        className = 'diff-hunk';
        html += `<div style="background:#e9ecef;color:#495057;font-weight:bold;">${this.escapeHtml(line)}</div>`;
      } else if (line.startsWith('+')) {
        className = 'diff-added';
        html += `<div style="background:#d4edda;color:#155724;">${this.escapeHtml(line)}</div>`;
      } else if (line.startsWith('-')) {
        className = 'diff-removed';
        html += `<div style="background:#f8d7da;color:#721c24;">${this.escapeHtml(line)}</div>`;
      } else {
        html += `<div>${this.escapeHtml(line)}</div>`;
      }
    }

    html += '</pre>';
    return html;
  },

  // HTMLè½¬ä¹‰
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },

  // æ›´æ–°å¼¹çª—ä¸­çš„æäº¤è®°å½•å†…å®¹
  updateCommitsInModal(fileName, commits, remoteUrl, startDate, endDate) {
    const filterHtml = `
      <div style="padding:10px;background:#f5f5f5;margin-bottom:10px;border-radius:4px;">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <span>æ—¶é—´èŒƒå›´ç­›é€‰ï¼š</span>
          <input type="date" id="historyStartDate" value="${startDate || ''}" placeholder="å¼€å§‹æ—¥æœŸ" style="padding:4px;">
          <span>è‡³</span>
          <input type="date" id="historyEndDate" value="${endDate || ''}" placeholder="ç»“æŸæ—¥æœŸ" style="padding:4px;">
          <button class="btn-blue" onclick="App.refreshFileHistory('${fileName}')" style="padding:4px 8px;">åˆ·æ–°</button>
          <button class="btn-gray" onclick="App.clearHistoryFilter()" style="padding:4px 8px;">æ¸…é™¤</button>
        </div>
      </div>
    `;

    let commitsHtml = commits.map(commit => {
      // ä½¿ç”¨æ–°çš„URLç”Ÿæˆå‡½æ•°
      const fileUrl = this.generateGitUrl(remoteUrl, commit.hash, fileName);

      return `
        <div class="git-commit">
          <div class="commit-header">
            <span>
              <span class="commit-hash">${commit.hash.substring(0, 7)}</span>
              <span class="commit-author">${commit.author}</span>
            </span>
            <span class="commit-date">${commit.date}</span>
          </div>
          <div class="commit-message">${commit.message}</div>
          <div style="margin-top:8px;">
            ${fileUrl ?
              `<a href="${fileUrl}" target="_blank" class="btn-blue" style="font-size:12px;padding:4px 8px;text-decoration:none;" title="åœ¨è¿œç¨‹ä»“åº“ä¸­æŸ¥çœ‹æ–‡ä»¶">
                æŸ¥çœ‹æ–‡ä»¶ â†’
              </a>
              <a href="${this.generateGitUrl(remoteUrl, commit.hash, '') || '#'}" target="_blank" class="btn-gray" style="font-size:12px;padding:4px 8px;text-decoration:none;margin-left:5px;" title="æŸ¥çœ‹æäº¤è¯¦æƒ…">
                æŸ¥çœ‹æäº¤ â†’
              </a>
              <button class="btn-green" style="font-size:12px;padding:4px 8px;margin-left:5px;" onclick="App.showFileDiff('${commit.hash}', '${encodeURIComponent(fileName)}')" title="æŸ¥çœ‹ä»£ç å·®å¼‚">
                æŸ¥çœ‹å·®å¼‚ â†’
              </button>` :
              '<span style="color:#999;font-size:12px;">æ— è¿œç¨‹ä»“åº“é“¾æ¥</span>'
            }
            <div id="diff-${commit.hash.substring(0, 7)}" style="display:none;margin-top:10px;"></div>
          </div>
        </div>
      `;
    }).join('');

    const content = document.getElementById('fileHistoryContent');
    content.innerHTML = filterHtml + commitsHtml;
  }
};

// æ‹–åŠ¨åŠŸèƒ½
class ModalDrag {
  constructor() {
    this.box = document.getElementById('modalBox');
    this.dragArea = document.getElementById('modalDrag');
    this.offsetX = 0;
    this.offsetY = 0;
    this.isDragging = false;
    this.init();
  }

  init() {
    this.dragArea.addEventListener('mousedown', this.startDrag.bind(this));
    document.addEventListener('mousemove', this.drag.bind(this));
    document.addEventListener('mouseup', this.stopDrag.bind(this));

    // æ·»åŠ æ‹–åŠ¨æ—¶çš„è§†è§‰æ•ˆæœ
    this.box.addEventListener('mousedown', () => {
      this.box.style.cursor = 'grabbing';
      this.box.style.transition = 'none';
    });
  }

  startDrag(e) {
    this.isDragging = true;
    const rect = this.box.getBoundingClientRect();
    this.offsetX = e.clientX - rect.left;
    this.offsetY = e.clientY - rect.top;
    this.dragArea.style.cursor = 'grabbing';
  }

  drag(e) {
    if (!this.isDragging) return;

    e.preventDefault();
    const x = e.clientX - this.offsetX;
    const y = e.clientY - this.offsetY;

    // é™åˆ¶åœ¨çª—å£å†…
    const maxX = window.innerWidth - this.box.offsetWidth;
    const maxY = window.innerHeight - this.box.offsetHeight;

    const finalX = Math.max(0, Math.min(x, maxX));
    const finalY = Math.max(0, Math.min(y, maxY));

    this.box.style.left = finalX + 'px';
    this.box.style.top = finalY + 'px';
    this.box.style.transform = 'none';
  }

  stopDrag() {
    this.isDragging = false;
    this.dragArea.style.cursor = 'move';
    this.box.style.cursor = '';
    this.box.style.transition = '';
  }
}

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', () => {
  App.init();
  new ModalDrag();

  // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
  document.getElementById("checkSaveBtn").onclick = async () => {
    App.closeCheck();
    // ä¿å­˜åˆ°åç«¯
    await App.saveData();
  };
});
</script>
</body>
</html>